---
title: "Oil sardine Forecast for 2016"
output:
  word_document: default
  html_document: default
---

Notes.  Show these figures compared to 5-year 'average'

* Precip by month
* Upwelling SST based
* SSH anomaly (not available yet)
* SST off coast
* Chlorophyll-a
* Show 5-yr landings compared to long-term pattern
* Forecast figure
* Table 1 Projection
* Table 2 Projection performance last 5 years.


```{r echo=FALSE,message=FALSE,warning=FALSE}
# Set up
library(SardineForecast)
library(knitr)
last.yr.data = 2015
TT=5 #years to average
dat=oilsardine_qtr
#which regions to include
regs=c("Kerala","Karnataka")
ymax=max(dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,regs],na.rm=TRUE)
```

```{r cov-figure-function, echo=FALSE,message=FALSE,warning=FALSE}
# Set up
TT=5 #years to average

covfig=function(covname, reg, last.yr.data, TT){
  box=3
  if(reg=="Kerala") box=3
  if(reg=="Karnataka") box=1
  if(covname=="Southern Oscillation Index") val="SOI"
  if(covname=="Precipitation" & reg=="Kerala") val="precip.gpcp.kerala"
  if(covname=="Precipitation" & reg=="Kernataka") val="precip.gpcp.kernataka"
  if(covname=="Wind Upwelling Index") val=paste("Wind.UPW.",box,sep="")
  if(covname=="SSTa Upwelling Index") val=paste("SST.UPW.",box,sep="")
  if(covname=="Chlorophyll-a") val=paste("CHL.",box,sep="")
  if(covname=="Sea Surface Temperature") val=paste("SST.",box,sep="")
  dat=seio_covariates_mon
  #ymin=quantile(dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,val],.05,na.rm=TRUE)
  if(covname=="Precipitation") ymin=0
  ymin=min(ifelse(covname=="Precipitation",0,NA),dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,val],na.rm=TRUE)
  #ymax=quantile(dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,val],.95,na.rm=TRUE)
  ymax=max(dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,val],na.rm=TRUE)

  par(mfrow=c(2,1))
datts = ts(dat[[val]],start=min(oilsardine_qtr$Year), frequency=12)
plot(window(datts, start=last.yr.data-TT+1, end=c(last.yr.data+1,7)),ylab=covname,xlab="",bty="L",ylim=c(ymin,ymax),type="b")
title(paste(covname,"off",reg, last.yr.data-TT+1, "to July", last.yr.data+1))

filt=dat$Year %in% (last.yr.data-10+1):last.yr.data
catchmeans=tapply(dat[[val]][filt], dat$Month[filt], mean, na.rm=TRUE)
filt=dat$Year %in% (last.yr.data-TT+1):last.yr.data
catchmeans=rbind(catchmeans,tapply(dat[[val]][filt], dat$Month[filt], mean, na.rm=TRUE))
filt=dat$Year %in% (last.yr.data+1)
catchmeans=rbind(catchmeans,dat[[val]][filt])
#make last 5 months of current year NA since bulletin coming out in Aug 1
catchmeans[3,8:12]=NA

colnames(catchmeans)=month.abb
rownames(catchmeans)=c("Last 10 years","Last 5 years",last.yr.data+1)
#ylims = c(min(0,catchmeans,na.rm=TRUE)*1.3,max(catchmeans,na.rm=TRUE)*1.3)
ylims=c(ymin, ymax)
barplot(catchmeans,ylab="",col=c("grey","black","blue"),cex.axis=.75,cex.names=.75,beside=TRUE, legend=rownames(catchmeans),ylim=ylims, xpd=FALSE)
title(paste("Average",covname))
}
```

# Precipitation by month

```{r fig1.kerala, echo=FALSE,fig.cap="Last 5 years of precipitation off the Kerala coast.",fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
covfig("Precipitation", "Kerala", last.yr.data, TT)
```


# SST anomaly-based upwelling index by month

```{r fig.upw.kerala, echo=FALSE,fig.cap="Last 5 years of the upwelling strength off the Kerala coast.",fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
covfig("SSTa Upwelling Index", "Kerala", last.yr.data, TT)
```

# SST by month

```{r fig.sst.kerala, echo=FALSE,fig.cap="Last 5 years of sea surface temperature off the Kerala coast.",fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
covfig("Sea Surface Temperature", "Kerala", last.yr.data, TT)
```

# Chlorophyll-a by month

```{r fig.chl.kerala, echo=FALSE,fig.cap="Last 5 years of Chlorophyll-a index off the Kerala coast.",fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
covfig("Chlorophyll-a", "Kerala", last.yr.data, TT)
```

# Monsoon onset date

```{r fig.onset, echo=FALSE,fig.cap="Monsoon onset date in Kerala relative to June 1st"}
if(length(onset$Year)%%5==0){ 
  end=length(onset$Year)
  yrend=onset$Year[end]
}else{
  end=length(onset$Year)+5-length(onset$Year)%%5+1
  yrend=onset$Year[length(onset$Year)]+5-length(onset$Year)%%5+1
}
barplot(onset$onset,col=ifelse(onset$onset<0,"red","black"),space=0)
axis(1, pos=min(onset$onset,na.rm=TRUE)*1.1, at=seq(1,end,5)-.5, labels=seq(onset$Year[1],yrend,5), cex.axis=.75 )
title("Monsoon onset date relative to June 1st")
```


# Quarterly catch last 5 years in Kerala and Karnataka

```{r landings-fig-setup, echo=FALSE,message=FALSE,warning=FALSE}
# Set up
TT=5 #years to average
dat=oilsardine_qtr
ymax=max(dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,c("Kerala","Karnataka","Goa")],na.rm=TRUE)

landingsfig=function(reg, last.yr.data, TT){
  par(mfrow=c(1,2))
  dat=oilsardine_qtr
datts = ts(dat[[reg]]/1000,start=min(oilsardine_qtr$Year), frequency=4)
plot(window(datts, start=last.yr.data-TT+1, end=c(last.yr.data,4)),ylab=paste(reg,"Catch (1000 kg)"),xlab="",bty="L",ylim=c(0,ymax/1000),type="b")
title(paste(reg, last.yr.data-TT+1, "to", last.yr.data))

catchmeans=tapply(dat[[reg]], dat$Qtr, mean, na.rm=TRUE)
filt=dat$Year %in% (last.yr.data-TT+1):last.yr.data
catchmeans=rbind(catchmeans,tapply(dat[[reg]][filt], dat$Qtr[filt], mean, na.rm=TRUE))
colnames(catchmeans)=paste("Qtr",1:4,sep=" ")
rownames(catchmeans)=c("Since 1956","Last 5 years")
ylims = c(0,max(catchmeans)*1.3/1000)
barplot(catchmeans/1000,ylab="",col=c("grey","black"),cex.axis=.75,cex.names=.75,beside=TRUE, legend=rownames(catchmeans),ylim=ylims)
title("Average Qtrly Catch (1000 kg)",cex.main=.75)
}
```

```{r fig2.kerala, echo=FALSE,fig.cap="Last 5 years of quarterly catch data for Kerala.  The catches have a strong seasonal pattern with the highest catches in quarter 4. Note that Quarter 3 is July-Sept and that the fishery is closed July 1 to Aug 15, thus the fishery is only open 1.5 months in quarter 3. The per month catch rate is second highest in quarter 3.",fig.width=8,fig.height=4,message=FALSE,warning=FALSE}
landingsfig("Kerala", last.yr.data, TT)
```

```{r fig2.karnataka, echo=FALSE,fig.cap="Last 5 years of quarterly catch data for Karnataka.  ",fig.width=8,fig.height=4,message=FALSE,warning=FALSE}
landingsfig("Karnataka", last.yr.data, TT)
```

```{r fig2.goa, eval=FALSE, echo=FALSE,fig.cap="Last 5 years of quarterly catch data for Goa.",fig.width=8,fig.height=4,message=FALSE,warning=FALSE}
landingsfig("Goa", last.yr.data, TT)
```

# Projected catch for upcoming year

```{r proj.fig.function, echo=FALSE}
TT=5 #years to average
dat=oilsardine_qtr
ymax=max(dat[dat$Year%in%(last.yr.data-TT+1):last.yr.data,c("Kerala","Karnataka","Goa")],na.rm=TRUE)

projcatchfig = function(reg, last.yr.data, TT){
  logged=TRUE
dat=oilsardine_qtr
datts = ts(dat[[reg]],start=min(oilsardine_qtr$Year), frequency=4)
datts=window(datts, start=1957, end=c(last.yr.data,4))
datts[datts==0]=NA
if(logged) datts=log(datts)
mod="AAA"
#fit <- ets(datts,model=mod, beta=.1, alpha=.1)
 fit <- ets(datts,model=mod)
fc=forecast(fit, level=c(30,80), h=4)
datts = ts(dat[[reg]]/1000,start=min(oilsardine_qtr$Year), frequency=4)
plot(window(datts, start=last.yr.data-TT+1, end=c(last.yr.data,4)),ylab=paste(reg,"Catch (1000 kg)"),xlab="",bty="L",ylim=c(0,ymax/1000),type="b",xlim=c(last.yr.data-TT+1,last.yr.data+2))
title(paste(reg, last.yr.data+1, "forecast"))
x1=last.yr.data+1 + seq(0,.75,.25)
polygon(c(last.yr.data+1,x1,rev(x1)),exp(c(fc$lower[1,2],fc$upper[,2],rev(fc$lower[,2])))/1000,col="grey80",border="grey80")
polygon(c(last.yr.data+1,x1,rev(x1)),exp(c(fc$lower[1,1],fc$upper[,1],rev(fc$lower[,1])))/1000,col="grey90",border="grey90")
lines(last.yr.data+1 + seq(0,.75,.25),exp(fc$mean)/1000,lwd=2)
}
```
```{r fig.proj.catch.kerala, echo=FALSE,fig.cap="Catch forecast for Kerala",fig.width=8,fig.height=5,message=FALSE,warning=FALSE}
projcatchfig("Kerala", last.yr.data, TT)
```

```{r projectedcatch-table, echo=FALSE}
projcatchtab = function(reg, last.yr.data, TT){
  cat("\n\n")
  cat(paste("##",reg))
  cat("\n\n")
  logged=TRUE
dat=oilsardine_qtr
datts = ts(dat[[reg]],start=min(oilsardine_qtr$Year), frequency=4)
datts=window(datts, start=1957, end=c(last.yr.data,4))
datts[datts==0]=NA
if(logged) datts=log(datts)
mod="AAA"
#fit <- ets(datts,model=mod, beta=.1, alpha=.1)
fit <- ets(datts,model=mod)
fc = exp(as.data.frame(forecast(fit, h=4, level=c(.3))))
yr.range = (last.yr.data-TT+1):last.yr.data
filt = oilsardine_qtr$Year %in% yr.range
Mean.qtr = tapply(oilsardine_qtr[[reg]][filt], oilsardine_qtr$Qtr[filt], mean, na.rm=TRUE)
Last.year = oilsardine_qtr[[reg]][oilsardine_qtr$Year %in% last.yr.data]
Actual = oilsardine_qtr[[reg]][oilsardine_qtr$Year %in% (last.yr.data+1):(last.yr.data+1)]
fc = data.frame(Mean=round(Mean.qtr), Last.year=Last.year, Actual=Actual, round(fc),row.names=rownames(fc))

mid.30 = fc$Lo.30 < fc$Mean & fc$Hi.30>fc$Mean
below.30 = fc$Hi.30 <= fc$Mean
above.30 = fc$Lo.30 >= fc$Mean
above.ave=fc$Point.Forecast>fc$Mean*1.1
below.ave=fc$Point.Forecast<fc$Mean*0.9
fc$mid.30 = paste(fc$Lo.30,"to",fc$Hi.30)
fc.text=ifelse(mid.30, "Within 5-year average", ifelse(below.30, "Below 5-year average", "Above 5-year average"))

# CHL column
box=3
if(reg=="Kerala") box=3
if(reg=="Kernataka") box=1
chl1=chl[chl$Year <= last.yr.data+1,]
quintiles=tapply(chl1[[paste("CHL.",box,sep="")]],chl1$Month, function(x){c(0,quantile(na.omit(x),c(.2,.4,.6,.8)))})
july.chl.quintile=max(which(chl[chl$Year == last.yr.data+1 & chl$Month==7,paste("CHL.",box,sep="")]>quintiles[[7]]))
june.chl.quintile=max(which(chl[chl$Year == last.yr.data+1 & chl$Month==6,paste("CHL.",box,sep="")]>quintiles[[6]]))
may.chl.quintile=max(which(chl[chl$Year == last.yr.data+1 & chl$Month==5,paste("CHL.",box,sep="")]>quintiles[[5]]))
mjj.quintiles=c(may.chl.quintile, june.chl.quintile, july.chl.quintile)
mjj.quintiles[is.infinite(mjj.quintiles)]=6
lev.chl=c()
for(i in mjj.quintiles)
lev.chl=c(lev.chl,switch(i, "Very low", "Low", "Average", "High", "Very high", "No data"))

# Precip column
covdat=precip[precip$Year <= last.yr.data+1,]
if(reg=="Kerala") dat1 = covdat$precip.gpcp.kerala
if(reg=="Karnataka") dat1 = covdat$precip.gpcp.karnataka

quintiles=tapply(dat1,covdat$Month, function(x){c(0,quantile(na.omit(x),c(.2,.4,.6,.8)))})
july.quintile=max(which(dat1[covdat$Year == last.yr.data+1 & covdat$Month==7]>quintiles[[7]]))
june.quintile=max(which(dat1[covdat$Year == last.yr.data+1 & covdat$Month==6]>quintiles[[6]]))
may.quintile=max(which(dat1[covdat$Year == last.yr.data+1 & covdat$Month==5]>quintiles[[5]]))
mjj.quintiles=c(may.quintile, june.quintile, july.quintile)
mjj.quintiles[is.infinite(mjj.quintiles)]=6
lev.precip=c()
for(i in mjj.quintiles)
lev.precip=c(lev.precip,switch(i, "Very low", "Low", "Average", "High", "Very high", "No data"))

cov.text=c(paste("July CHL:", lev.chl[3]), paste("June Precip:", lev.precip[2]), "", "")

fc.table = data.frame(Mean=round(Mean.qtr), Forecast=fc.text, Mid.30=fc$mid.30, cov=cov.text, row.names=rownames(fc))
colnames(fc.table)=c(paste("Ave landings",last.yr.data-TT+1,"to",last.yr.data),paste("Projected landings in",last.yr.data+1), "Middle 30% Projection", "Environmental Conditions")
print(kable(fc.table[,c(1,3,2,4)], align='cccc'))


}
```

```{r, echo=FALSE, message=FALSE,warning=FALSE, results='asis'}
for(reg in regs) projcatchtab(reg, last.yr.data, TT)
```



# Projection performance last 5 years

```{r projectedcatchperf-table, echo=FALSE}
projperftab=function(reg, last.yr.data, TT){
  cat("\n\n")
  cat(paste("##",reg))
  cat("\n\n")
logged=TRUE
mod="AAA"
dat=oilsardine_qtr
datts = ts(dat[[reg]],start=min(oilsardine_qtr$Year), frequency=4)
datts[datts==0]=NA
if(logged) datts=log(datts)
fc.table=c()
for(yr in (last.yr.data-5):(last.yr.data-1)){
datts.yr=window(datts, start=1957, end=c(yr,4))
fit <- ets(datts.yr,model=mod, beta=.1)
fc = exp(as.data.frame(forecast(fit, h=4, level=c(.3))))
yr.range = (yr-TT+1):yr
filt = oilsardine_qtr$Year %in% yr.range
Mean.qtr = tapply(oilsardine_qtr[[reg]][filt], oilsardine_qtr$Qtr[filt], mean, na.rm=TRUE)
Actual = oilsardine_qtr[[reg]][oilsardine_qtr$Year %in% (yr+1)]
fc = data.frame(Mean=round(Mean.qtr), Actual=Actual, round(fc), row.names=rownames(fc))
fc$mid.30 = paste(fc$Lo.30,"to",fc$Hi.30)

mid.30.actual = fc$Lo.30 < fc$Actual & fc$Hi.30>fc$Actual
fc$fc.text.actual=ifelse(fc$Actual<fc$Lo.30, paste("Below ",round(100*(fc$Lo.30-fc$Actual)/fc$Lo.30),"%",sep=""), ifelse(mid.30.actual, "Within", paste("Above ",round(100*(fc$Actual-fc$Hi.30)/fc$Hi.30),"%",sep="")))

fc.table = rbind(fc.table, fc[,c("Actual","mid.30", "fc.text.actual")])
}
colnames(fc.table)=c("Actual landings", "Middle 30%  Projection", "Actual vs Mid 30%")

print(kable(fc.table, align='ccccc'))
}
```

```{r, echo=FALSE, message=FALSE,warning=FALSE, results='asis'}
for(reg in regs) projperftab(reg, last.yr.data, TT)
```

